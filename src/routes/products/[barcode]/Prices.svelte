<script lang="ts">
	import { preventDefault } from 'svelte/legacy';

	import { PricesApi, type Prices } from '$lib/api/prices';
	import { onMount } from 'svelte';
	import type { Currency, NewPrice } from '$lib/types/currency';

	import { getNearStores, idToName, type OverpassAPIResult } from '$lib/location';
	import { invalidateAll } from '$app/navigation';

	interface Props {
		prices: Prices;
		barcode: string;
	}

	let { prices, barcode }: Props = $props();

	let pricesApi: PricesApi;
	let authenticated: boolean = $state(false);
	let authStatus: undefined | boolean = $state();

	let nearStores: OverpassAPIResult | undefined = $state();

	onMount(async () => {
		pricesApi = new PricesApi(fetch);
		authenticated = await pricesApi.isAuthenticated();

		nearStores = await getNearStores();
	});

	let newPrice: NewPrice = $state({
		price: 0,
		currency: 'EUR',
		location_osm_id: 0,
		location_osm_type: undefined,
		date: new Date().toISOString().split('T')[0],
		proof_id: 0
	});

	let loginFields = $state({ email: '', password: '' });

	async function login() {
		console.debug('Logging in...');
		const res = await pricesApi.login({
			username: loginFields.email,
			password: loginFields.password
		});

		if (!res.response.ok) {
			console.error('Error while logging in', res.error);
			authStatus = false;
			setTimeout(() => {
				authStatus = undefined;
			}, 2000);
			return;
		}

		try {
			console.debug('Logged in', res.data);
			authStatus = true;
			setTimeout(() => {
				authenticated = true;
			}, 1000);
		} catch (error) {
			console.error('Error while logging in', error);
			authStatus = false;
			setTimeout(() => {
				authStatus = undefined;
			}, 2000);
		}
	}

	async function submitPrice() {
		const type = nearStores?.elements
			.find((el) => el.id === newPrice.location_osm_id)
			?.type?.toUpperCase();
		if (type == null) {
			throw new Error("Illegal state: Couldn't find store type");
		}

		const res = await pricesApi.createPrice({
			product_code: barcode,
			price: newPrice.price,
			currency: newPrice.currency,
			date: newPrice.date,
			location_osm_id: newPrice.location_osm_id,
			location_osm_type: type as 'NODE' | 'WAY' | 'RELATION',
			proof_id: newPrice.proof_id
		});

		if (!res.response.ok) {
			console.error('Error while submitting price', res.error);
			return;
		}

		if (res.data != null) {
			console.warn('Data is null');
			return;
		}

		try {
			console.debug('Submitted price', res.data);
			prices = {
				...prices,
				count: prices.count + 1,
				results: [...prices.results, res.data as Prices['results'][0]]
			};
			invalidateAll();
		} catch (error) {
			if (error instanceof Error) {
				console.error('Error while submitting price:', error.message);
			} else {
				console.error('Error while submitting price:', error);
			}
		}
	}
</script>

<div>
	<div id="prices">
		<span class="font-bold">
			Prices: {prices.count}
		</span>
		<table class="table-zebra table">
			<thead>
				<tr>
					<th>Price</th>
					<th>Store</th>
					<th>Date</th>
				</tr>
			</thead>
			<tbody>
				{#each prices.results as price (price.id)}
					<tr>
						<td>{price.price + ' ' + price.currency}</td>
						<td>
							{#await idToName(fetch, price.location_osm_id ?? 0)}
								Loading...
							{:then storeName}
								{#if price.location_osm_id && price.location_osm_id !== 0}
									<a
										href={`https://www.openstreetmap.org/${(price.location_osm_type ?? 'node').toLowerCase()}/${
											price.location_osm_id
										}`}
									>
										{storeName}
									</a>
								{:else}
									{storeName}
								{/if}
							{:catch error}
								<span class="text-red-500">
									Error: {error instanceof Error ? error.message : error}
								</span>
							{/await}
						</td>
						<td>
							{#if price.date != null}
								{new Date(price.date).toLocaleDateString()}
							{:else}
								No date
							{/if}
						</td>
					</tr>
				{/each}
			</tbody>
		</table>
	</div>

	<div class="my-4" id="new-price">
		{#if authenticated == null}
			<progress class="progress progress-primary"></progress>
		{:else if authenticated}
			<h3 class="text-2xl font-bold">Report a new price</h3>
			<form
				class="my-2 grid grid-flow-col grid-rows-2 gap-x-3"
				onsubmit={(e) => {
					e.preventDefault();
					submitPrice();
				}}
			>
				<label for="price" class="label">
					<span class="label-text">Price</span>
				</label>
				<input
					type="number"
					bind:value={newPrice.price}
					name="price"
					id="price"
					class="input input-bordered"
				/>

				<label for="currency" class="label">
					<span class="label-text">Currency</span>
				</label>
				<select
					class="select select-bordered"
					bind:value={newPrice.currency}
					name="currency"
					id="currency"
				>
					<option value="EUR">EUR</option>
					<option value="USD">USD</option>
					<option value="GBP">GBP</option>
					<option value="JPY">JPY</option>
					<option value="CNY">CNY</option>
					<option value="INR">INR</option>
					<option value="AUD">AUD</option>
					<option value="CAD">CAD</option>
					<option value="CHF">CHF</option>
					<option value="HKD">HKD</option>
				</select>

				<label for="store" class="label">
					<span class="label-text">Store</span>
				</label>

				{#if nearStores == null}
					<div>Loading...</div>
				{:else if nearStores.elements.length === 0}
					<div>No stores found</div>
				{:else}
					<select class="select select-bordered" name="store" bind:value={newPrice.location_osm_id}>
						{#each nearStores?.elements as store (store.id)}
							<option value={store.id}>{store.tags.name}</option>
						{/each}
					</select>
				{/if}

				<div></div>
				<button class="btn" type="submit">Submit</button>
			</form>
		{:else}
			<h2 class="mb-4 text-2xl font-bold">Login</h2>
			<form class="space-y-4" onsubmit={preventDefault(login)}>
				<div>
					<label for="email" class="block font-medium">Email</label>
					<input type="text" bind:value={loginFields.email} class="input input-bordered w-full" />
				</div>
				<div>
					<label for="password" class="block font-medium">Password</label>
					<input
						type="password"
						bind:value={loginFields.password}
						class="input input-bordered w-full"
					/>
				</div>
				<div>
					<button type="submit" class="btn btn-primary w-full">Login</button>
				</div>
			</form>

			{#if authStatus}
				<div class="alert alert-success mt-4">Logged in!</div>
			{:else if authStatus === false}
				<div class="alert alert-error mt-4">Error while logging in</div>
			{/if}
		{/if}
	</div>
</div>
